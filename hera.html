<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- Google Fontsのリンクとカスタムフォント定義 -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Uzura&display=swap">
  <style>
    /* フォント uzura を読み込み */
    @font-face {
      font-family: 'Uzura';
      src: url('./font/uzura.ttf') format('truetype');
    }

    /* 開始ボタンのふんわり点滅アニメーション */
    @keyframes blink-border {
      0%   { border-color: rgba(255, 0, 0, 0.8); box-shadow: 0 0 8px rgba(255, 0, 0, 0.4); }
      50%  { border-color: rgba(255, 0, 0, 0.2); box-shadow: 0 0 4px rgba(255, 0, 0, 0.1); }
      100% { border-color: rgba(255, 0, 0, 0.8); box-shadow: 0 0 8px rgba(255, 0, 0, 0.4); }
    }
  </style>
  <meta charset="UTF-8">
  <title>ウキが浮かぶ釣り場</title>
  <style>
    /* ページ全体の初期設定 */
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: black;
    }

    /* コンテナ（背景・ウキ・パネルを含む） */
    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }

    /* 背景画像（釣り場） */
    #background {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: contain;
      z-index: 0;
    }

    /* ウキをマスクするためのラッパー */
    #uki-wrapper {
      position: absolute;
      overflow: hidden;
      z-index: 2;
      pointer-events: none;
      display: none; /* 初期状態でウキを非表示 */
    }

    /* ウキ画像 */
    #uki {
      display: block;
      position: absolute;
      left: 0;
      top: 0;
      transform-origin: top left;
    }

    /* 操作パネル（右下） */
    #control-panel {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 10px 15px;
      border-radius: 10px;
      font-family: sans-serif;
      font-size: 14px;
      z-index: 3;
    }

    /* 投入ボタンとアワセボタンの共通スタイル */
    .control-button {
      padding: 5px 10px;
      font-size: 48pt;
      font-family: 'Uzura', sans-serif;
      background: linear-gradient(to bottom, #ffffff, #dddddd);
      border-radius: 8px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
      cursor: pointer;
      display: block; /* Ensure both buttons take full width */
      pointer-events: auto;
      width: 250px; /* 揃えるために固定幅を設定 */
      text-align: center; /* 中央揃え */
    }

    /* 投入ボタン */
    #start-button {
      border: 5px solid red;
      animation: blink-border 2s infinite;
    }

    /* アワセボタン */
    #set-button {
      margin-top: 10px;
    }

    /* 経過時間表示 */
    #timer {
      margin-top: 5px;
      font-weight: bold;
      font-size: 48pt;
      font-family: 'Uzura', sans-serif;
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- 背景画像 -->
    <img id="background" src="turiba.png" alt="釣り場の背景">
    <!-- ウキ -->
    <div id="uki-wrapper">
      <img id="uki" src="herauki.png" alt="ウキ">
    </div>
    <!-- 操作パネル -->
    <div id="control-panel">
      <button id="start-button" class="control-button">投入</button> <!-- 投入ボタン -->
      <button id="set-button" class="control-button" disabled>アワセ</button> <!-- アワセボタン -->
      <div id="timer">00:00:00</div>
    </div>
  </div>

  <script>
    // DOM要素の参照
    const background = document.getElementById('background'); // 背景画像（釣り場の風景）のimg要素
    const uki = document.getElementById('uki'); // ウキの画像要素
    const ukiWrapper = document.getElementById('uki-wrapper'); // ウキをマスク表示するためのラッパーdiv
    const container = document.getElementById('container'); // 全体のコンテナdiv

    const startButton = document.getElementById('start-button'); // 「投入」ボタン
    const setButton = document.getElementById('set-button'); // 「アワセ」ボタン
    const timerDisplay = document.getElementById('timer'); // 経過時間を表示するdiv

    // タイマー制御用変数
    let startTime = null; // 開始ボタンを押した時間（Dateオブジェクト）
    let timerInterval = null; // setIntervalのID、タイマー更新用

    // ウキ表示調整用スケール変数
    let ukiScale = 1; // ウキの拡大率（背景に対する相対サイズ）
    let maskHeight = 0; // ウキの上半分の高さ（マスク用）
    let scaledHeight = 0; // スケーリング後のウキの高さ（px）

    // タイマー開始フラグ
    let timerStarted = false;

    // ウキと背景のサイズ・位置調整関数
    function positionUki() {
      const containerRect = container.getBoundingClientRect(); // コンテナのサイズ情報を取得
      const bgRatio = background.naturalWidth / background.naturalHeight; // 背景画像の縦横比
      const containerRatio = containerRect.width / containerRect.height; // コンテナの縦横比

      let bgDisplayWidth, bgDisplayHeight;
      if (bgRatio > containerRatio) { // 背景が横に広い場合：幅を基準にスケーリング
        bgDisplayWidth = containerRect.width;
        bgDisplayHeight = containerRect.width / bgRatio;
      } else { // 背景が縦に長い場合：高さを基準にスケーリング
        bgDisplayHeight = containerRect.height;
        bgDisplayWidth = containerRect.height * bgRatio;
      }

      const bgScale = bgDisplayWidth / background.naturalWidth; // 背景を表示したときのスケール（幅基準）
      ukiScale = bgScale * 0.2;

      const originalWidth = uki.naturalWidth; // ウキ画像のオリジナル幅
      const originalHeight = uki.naturalHeight; // ウキ画像のオリジナル高さ
      const scaledWidth = originalWidth * ukiScale; // スケーリング後のウキの幅
      scaledHeight = originalHeight * ukiScale;
      maskHeight = scaledHeight / 2;

      const bgLeft = (containerRect.width - bgDisplayWidth) / 2; // 背景を中央に寄せるための左マージン
      const bgTop = (containerRect.height - bgDisplayHeight) / 2; // 背景を中央に寄せるための上マージン

      const centerX = bgLeft + (bgDisplayWidth - scaledWidth) / 2; // ウキを背景中央に配置するX座標
      const fixedWaterlineY = bgTop + bgDisplayHeight * 0.75; // 水面のY座標（背景の下1/4）

      ukiWrapper.style.left = `${centerX}px`;
      ukiWrapper.style.top = `${fixedWaterlineY - maskHeight}px`;
      ukiWrapper.style.width = `${scaledWidth}px`;
      ukiWrapper.style.height = `${maskHeight}px`;

      uki.style.width = `${originalWidth}px`;
      uki.style.height = `${originalHeight}px`;
      uki.style.transform = `scale(${ukiScale})`;
      uki.style.top = `0px`;
    }

    // 画像読み込み完了後にコールバック実行
    function whenLoaded(img, callback) {
      if (img.complete) callback(); // 画像がすでに読み込まれている場合、すぐにコールバック実行
      else img.onload = callback; // 読み込みがまだの場合、onloadでコールバック実行
    }

    // ウキをランダムに上下揺らす関数
    function animateUki(intensity = 1) {
      const offset = (Math.random() * 2 - 1) * 2 * intensity; // ランダムな上下揺れ幅（-2〜2px）
      uki.style.transition = 'top 0.2s ease-in-out';
      uki.style.top = `${offset}px`;
    }

    // ランダムなBGM再生を制御
    function playRandomBGM() {
      const bgmList = [
        './bgm/ウグイス.mp3', './bgm/ウグイスのさえずり1.mp3', './bgm/オオヨシキリのさえずり.mp3',
        './bgm/カッコウ.mp3', './bgm/カッコウの鳴き声.mp3', './bgm/カラスが鳴く夕方.mp3',
        './bgm/カラスに囲まれる.mp3', './bgm/キジ.mp3', './bgm/キジバトのさえずり1.mp3',
        './bgm/ヒバリのさえずり.mp3', './bgm/ホトトギス.mp3', './bgm/ミソサザイ.mp3'
      ]; // BGMファイルのリスト

      const audio = new Audio(); // BGM再生用のAudioインスタンス

      function playNextBGM() {
        const index = Math.floor(Math.random() * bgmList.length); // BGMリストからランダムに選ぶインデックス
        const loopCount = Math.floor(Math.random() * 5) + 1; // 選ばれたBGMの繰り返し回数（1〜5回）
        const delay = Math.random() * 180000; // 次のBGM再生までの遅延（最大3分）
        const volume = 0.1 + Math.random() * 0.9; // 音量（遠近感を出すため0.1〜1.0のランダム）
        const pause = 1000 + Math.random() * 2000; // BGMループ間のポーズ（1〜3秒）

        audio.src = bgmList[index];
        audio.volume = volume;
        audio.loop = false;

        let count = 0;
        audio.onended = () => {
          count++;
          if (count < loopCount) { // 指定された回数だけ同じBGMを繰り返す
            setTimeout(() => audio.play(), pause);
          } else {
            setTimeout(playNextBGM, delay);
          }
        };

        audio.play().catch(e => {
          console.log('Audio playback failed (user interaction required)', e);
        });
      }

      document.body.addEventListener('click', () => {
        playNextBGM();
      }, { once: true });
    }

    // タイマーを更新する関数（HH:MM:SS）
    function updateTimer() {
      const now = new Date(); // 現在時刻
      const elapsed = new Date(now - startTime); // 経過時間をDateオブジェクトに変換
      const hh = String(elapsed.getUTCHours()).padStart(2, '0'); // 時（2桁ゼロ埋め）
      const mm = String(elapsed.getUTCMinutes()).padStart(2, '0'); // 分（2桁ゼロ埋め）
      const ss = String(elapsed.getUTCSeconds()).padStart(2, '0'); // 秒（2桁ゼロ埋め）
      timerDisplay.textContent = `${hh}:${mm}:${ss}`;
    }

    // 「投入」ボタンが押されたときの処理
    startButton.addEventListener('click', () => {
      // 効果音：投入ボタンを押したとき
      new Audio('./se/decision22.mp3').play();

      // 2秒後にBGMを開始
      setTimeout(() => {
        playRandomBGM();
      }, 2000);

      // ボタンとウキの設定
      ukiWrapper.style.display = 'block';
      setButton.style.display = 'block';
      setTimeout(() => {
        setButton.disabled = false; // 「アワセ」ボタンを3秒後に有効化
      }, 3000);
      startButton.disabled = true; // 「投入」ボタンを無効化

      // 投入ボタンのスタイル変更
      startButton.style.border = 'none';
      startButton.style.animation = 'none';

      // タイマーがまだ開始されていない場合のみ、タイマーを開始する
      if (!timerStarted) {
        // 2秒後にBGMを開始
        setTimeout(() => {
          playRandomBGM();
        }, 2000);

        // タイマーの初期化
        startTime = new Date();
        updateTimer();
        timerInterval = setInterval(updateTimer, 1000);
        timerStarted = true; // タイマー開始フラグを立てる
      }
    });

    // 「アワセ」ボタンが押されたときの処理
    setButton.addEventListener('click', () => {
      // 効果音：アワセボタンを押したとき
      new Audio('./se/sword-gesture2.mp3').play();
      
      // ウキを非表示にする
      ukiWrapper.style.display = 'none';
      
      // ボタンの状態を変更
      //setButton.style.display = 'none';
      setButton.disabled = true; // 「アワセ」ボタンを無効化
      setTimeout(() => {
        startButton.disabled = false; // 「投入」ボタンを3秒後に有効にする
      }, 3000);
    });

    // ページ初期化処理
    whenLoaded(background, () => {
      whenLoaded(uki, () => {
        positionUki(); // サイズ調整
        window.addEventListener('resize', positionUki);
        setInterval(() => animateUki(), 200); // ウキを動かす
      });
    });
  </script>
</body>
</html>
